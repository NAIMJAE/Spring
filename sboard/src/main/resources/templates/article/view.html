<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="/layout/defaultLayout.html">
    <!--내용 시작-->
        <div class="container-fluid px-4" layout:fragment="content">

            <script>
                window.onload = function (){
                    // 파일 다운로드
                    const fileLinks = document.getElementsByClassName('fileLink');

                    for(const fileLink of fileLinks){

                        // 파일 다운로드 요청과 동시에 다운로드 카운트 요청
                        fileLink.onclick = function () {

                            const count = this.nextElementSibling.innerText;
                            this.nextElementSibling.innerText = parseInt(count) + 1;
                        }
                    }


                    const CommentForm = document.CommentForm;
                    const ul = document.getElementById('commentUl');
                    const btnCommentSubmit = document.getElementById('btnCommentSubmit');
                    const btnCommentCancel = document.getElementById('btnCommentCancel');
                   // const btnCommentDelete = document.querySelectorAll('.btnCommentDelete');
                    //const btnCommentDeleteArray = document.querySelectorAll('.btnCommentDelete');
                   // const btnCommentModify = document.querySelectorAll('.btnCommentModify');

                    // 댓글 작성
                    btnCommentSubmit.onclick = function (){
                        const parent = CommentForm.parent.value;
                        const writer = CommentForm.writer.value;
                        const content = CommentForm.content.value;

                        const jsonData = {
                            "parent" : parent,
                            "writer" : writer,
                            "content" : content
                        }
                        if (content != null){
                            // 입력
                            fetch("/sboard/article/comment",{
                                method: "POST",
                                headers: {"content-Type": "application/json"},
                                body: JSON.stringify(jsonData)
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data);
                                    // 날짜 자르기
                                    const date = data.rdate.substring(0, 10);
                                    // 방금 작성한 댓글 동적으로 태그 생성
                                    const il =
                                        `<li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto col-sm-10">
                                                <div class="fw-bold nameDate">${data.writer} | ${date}</div>
                                                <textarea class="col-sm-12 border-0" name="content" style="outline: none; resize: none;" readonly>${data.content}</textarea>
                                            </div>
                                            <button type="button" class="me-2 mt-2 btn btn-sm btn-outline-secondary btnCommentLeft" data-no="${data.no}">삭제</button>
                                            <button type="button" class="mt-2 btn btn-sm btn-outline-secondary btnCommentRight" data-no="${data.no}">수정</button>
                                        </li>`
                                    ul.insertAdjacentHTML('beforeend', il);

                                    CommentForm.content.value = "";
                                    alert("댓글을 작성했습니다.")
                                })
                                .catch(err => {
                                    console.log(err);
                                })
                        } else {
                            alert("댓글 내용을 입력해주세요.")
                        }
                    }
                    // 댓글 취소
                    btnCommentCancel.onclick = function () {
                        CommentForm.content.value = "";
                    }

            ////////////////////////댓글 수정 / 삭제 / 취소 / 저장//////////////////////////
                    let oValue = null;
                    let editing = false;

                    document.addEventListener('click', async function (e){
                        const btnValue = e.target.textContent;
                        // 삭제
                        if (btnValue === "삭제" && editing === false){
                            e.preventDefault();
                            const no = e.target.dataset.no;
                            const li = e.target.parentElement;
                            const result = confirm("정말 삭제하시겠습니까?");
                            if(result){
                                await fetch(`/sboard/article/commentDelete/${no}`)
                                    .then(response => {
                                        if (!response.ok) {throw new Error('댓글 삭제에 실패했습니다.');}
                                        return response.json()
                                    })
                                    .then(data => {
                                        alert('댓글이 삭제 되었습니다.');
                                        li.remove();
                                    }).catch(err => console.log(err));
                            }
                        }else if(btnValue === "취소"){
                            e.preventDefault();
                            const textarea = e.target.parentElement.querySelector('textarea');
                            const btnLeft = e.target;
                            const btnRight = e.target.nextElementSibling;

                            textarea.value = oValue;
                            textarea.readOnly = true;
                            textarea.style.outline = "none"
                            btnLeft.innerText = "삭제"
                            btnRight.innerText = "수정"
                            editing = false;

                        }else if(btnValue === "수정" && editing === false){
                            e.preventDefault();
                            editing = true;
                            const textarea = e.target.parentElement.querySelector('textarea');
                            const btnRight = e.target;
                            const btnLeft = e.target.previousElementSibling;
                            // 수정 전 내용 저장
                            oValue = textarea.value;

                            textarea.readOnly = false;
                            textarea.style.outline = "1px solid #111"
                            textarea.focus();
                            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                            // 버튼 수정
                            btnLeft.innerText = "취소"
                            btnRight.innerText = "저장"

                        }else if(btnValue === "저장"){
                            e.preventDefault();
                            const no = e.target.dataset.no;
                            const textarea = e.target.parentElement.querySelector('textarea');
                            const div = e.target.parentElement.querySelector('.nameDate');
                            const content = textarea.value;
                            const btnRight = e.target;
                            const btnLeft = e.target.previousElementSibling;

                            await fetch(`/sboard/article/commentModify/${no}/${content}`)
                                .then(response => {
                                    if(!response){throw new Error('댓글 수정에 실패했습니다.');}
                                    return response.json();
                                })
                                .then(data => {
                                    textarea.innerText = `${data.content}`;
                                    div.innerText = `${data.writer} | ${data.substring(0,10)}`;
                                    textarea.readOnly = true;
                                    textarea.style.outline = "none"
                                    btnLeft.innerText = "삭제"
                                    btnRight.innerText = "수정"
                                }).catch(err => console.log(err))
                            editing = false;
                        }
                    });
                }
            </script>

            <h1 class="mt-4">게시판 글보기</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active"></li>
            </ol>


            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    0000 게시판 글보기
                </div>
                <div class="card-body">

                <!--글보기-->
                <!--글제목-->
                    <input type="hidden" name="cate" th:value="${cate}">
                    <div class="mb-3">
                        <label for="exampleFormControlInput1" class="form-label">제목</label>
                        <input type="text" class="form-control" name="title" id="exampleFormControlInput1"
                               th:value="${article.title}" readonly>
                    </div>
                <!--첨부파일-->
                    <ul class="list-group" th:if="${article.file > 0}">
                        <label class="form-label">첨부파일</label>
                        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="file : ${article.fileList}">
                            <a th:href="@{/article/fileDownload(fno=${file.fno})}" class="fileLink" th:data-fno="${file.fno}" th:text="${file.oName}"></a>
                            <span class="badge text-bg-primary rounded-pill" th:text="${file.download}"></span>
                        </li>
                    </ul>
                <!--글내용-->
                    <div class="mb-3">
                        <label for="exampleFormControlTextarea1" class="form-label"><br>내용</label>
                        <textarea class="form-control" name="content" id="exampleFormControlTextarea1" rows="10"
                                  th:text="${article.content}" readonly></textarea>
                    </div>
                <!--목록 / 수정 버튼-->
                    <div class="text-end">
                        <a th:href="@{/article/list}" class="btn btn-secondary">목록</a>
                        <th:block th:if="${article.writer} == ${#authentication.principal.user.uid}">
                            <a th:href="@{/article/modify(no=${article.no})}" class="btn btn-primary" id="btnSubmit">수정</a>
                        </th:block>
                    </div>

                <!--댓글 작성-->
                    <form name="CommentForm">
                        <div class="mb-3">
                            <input type="hidden" name="parent" th:value="${article.no}">
                            <input type="hidden" name="writer" th:value="${#authentication.principal.user.uid}">
                            <label for="exampleFormControlTextarea2" class="form-label"><br>댓글 작성</label>
                            <textarea class="form-control" name="content" id="exampleFormControlTextarea2" rows="3"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnCommentCancel">취소</button>
                            <button type="button" class="btn btn-primary btn-sm" id="btnCommentSubmit">작성</button>
                        </div>
                    </form>

                <!--댓글 목록-->
                    <label for="commentUl" class="form-label"><br>댓글 목록</label>
                    <ul class="list-group list-group" id="commentUl">
                        <li class="list-group-item d-flex justify-content-between align-items-start" th:each="comment : ${comments}">
                            <div class="ms-2 me-auto col-sm-10">
                                <div class="fw-bold nameDate">[[${comment.writer}]] | [[${#strings.substring(comment.rdate, 0, 10)}]]</div>
                                <textarea class="col-sm-12 border-0" name="content" style="outline: none; resize: none;" readonly>[[${comment.content}]]</textarea>
                            </div>
                            <th:block th:if="${comment.writer} == ${#authentication.principal.user.uid}">
                            <button type="button" class="me-2 mt-2 btn btn-sm btn-outline-secondary btnCommentLeft" th:data-no="${comment.no}">삭제</button>
                            <button type="button" class="mt-2 btn btn-sm btn-outline-secondary btnCommentRight" th:data-no="${comment.no}">수정</button>
                            </th:block>
                        </li>
                    </ul>

                </div> <!--card-body end-->
            </div>

        </div>
    <!--내용 끝-->
</html>
