<html xmlns:th="http://www.thymeleaf.org"
    xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
    layout:decorate="/layout/defaultLayout.html">
    <!--내용 시작-->
        <div class="container-fluid px-4" layout:fragment="content">

            <script>
                window.onload = function (){
                    // 파일 다운로드



                    // 댓글 작성
                    const CommentForm = document.CommentForm;
                    const ul = document.getElementById('commentUl');
                    const btnCommentSubmit = document.getElementById('btnCommentSubmit');
                    const btnCommentCancel = document.getElementById('btnCommentCancel');
                   // const btnCommentDelete = document.querySelectorAll('.btnCommentDelete');
                    //const btnCommentDeleteArray = document.querySelectorAll('.btnCommentDelete');
                   // const btnCommentModify = document.querySelectorAll('.btnCommentModify');

                    btnCommentSubmit.onclick = function (){
                        const parent = CommentForm.parent.value;
                        const writer = CommentForm.writer.value;
                        const content = CommentForm.content.value;

                        const jsonData = {
                            "parent" : parent,
                            "writer" : writer,
                            "content" : content
                        }
                        if (content != null){
                            // 입력
                            fetch("/sboard/article/comment",{
                                method: "POST",
                                headers: {"content-Type": "application/json"},
                                body: JSON.stringify(jsonData)
                            })
                                .then(response => response.json())
                                .then(data => {
                                    console.log(data);
                                    // 날짜 자르기
                                    const date = data.rdate.substring(0, 10);
                                    // 방금 작성한 댓글 동적으로 태그 생성
                                    const il =
                                        `<li class="list-group-item d-flex justify-content-between align-items-start">
                                            <div class="ms-2 me-auto col-sm-10">
                                                <div class="fw-bold">${data.writer} | ${date}</div>
                                                <textarea class="col-sm-12 border-0" style="outline: none; resize: none;" readonly>${data.content}</textarea>
                                            </div>
                                            <button type="button" class="me-2 mt-2 btn btn-sm btn-outline-secondary btnCommentDelete">삭제</button>
                                            <button type="button" class="mt-2 btn btn-sm btn-outline-secondary btnCommentModify">수정</button>
                                        </li>`
                                    ul.insertAdjacentHTML('beforeend', il);

                                    CommentForm.content.value = "";
                                    alert("댓글을 작성했습니다.")
                                })
                                .catch(err => {
                                    console.log(err);
                                })
                        } else {
                            alert("댓글 내용을 입력해주세요.")
                        }
                    }
                    // 댓글 취소
                    btnCommentCancel.onclick = function () {
                        CommentForm.content.value = "";
                    }
                    // 댓글 삭제

                    // 댓글 수정
                    const btnCommentModify = document.querySelectorAll('.btnCommentModify');

                    btnCommentModify.forEach(function (item) {
                        item.addEventListener('click', function (e) {

                            const textarea = e.target.parentElement.querySelector('textarea');
                            textarea.readOnly = false;
                            textarea.style.outline = "1px solid #111"
                            textarea.focus();
                            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
                        });
                    });
                }
            </script>

            <h1 class="mt-4">게시판 글보기</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active"></li>
            </ol>


            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    0000 게시판 글보기
                </div>
                <div class="card-body">

                <!--글보기-->
                <!--글제목-->
                    <input type="hidden" name="cate" th:value="${cate}">
                    <div class="mb-3">
                        <label for="exampleFormControlInput1" class="form-label">제목</label>
                        <input type="text" class="form-control" name="title" id="exampleFormControlInput1"
                               th:value="${article.title}" readonly>
                    </div>
                <!--첨부파일-->
                    <ul class="list-group" th:if="${article.file > 0}">
                        <label class="form-label">첨부파일</label>
                        <li class="list-group-item d-flex justify-content-between align-items-center" th:each="file : ${article.fileList}">
                            <a th:href="@{/article/fileDownload(fno=${file.fno})}" th:text="${file.oName}"></a>
                            <span class="badge text-bg-primary rounded-pill" th:text="${file.download}"></span>
                        </li>
                    </ul>
                <!--글내용-->
                    <div class="mb-3">
                        <label for="exampleFormControlTextarea1" class="form-label"><br>내용</label>
                        <textarea class="form-control" name="content" id="exampleFormControlTextarea1" rows="10"
                                  th:text="${article.content}" readonly></textarea>
                    </div>
                <!--목록 / 수정 버튼-->
                    <div class="text-end">
                        <a th:href="@{/article/list}" class="btn btn-secondary">목록</a>
                        <th:block th:if="${article.writer} == ${#authentication.principal.user.uid}">
                            <a th:href="@{/article/write}" class="btn btn-primary" id="btnSubmit">수정</a>
                        </th:block>
                    </div>

                <!--댓글 작성-->
                    <form name="CommentForm">
                        <div class="mb-3">
                            <input type="hidden" name="parent" th:value="${article.no}">
                            <input type="hidden" name="writer" th:value="${#authentication.principal.user.uid}">
                            <label for="exampleFormControlTextarea2" class="form-label"><br>댓글 작성</label>
                            <textarea class="form-control" name="content" id="exampleFormControlTextarea2" rows="3"></textarea>
                        </div>
                        <div class="text-end">
                            <button type="button" class="btn btn-secondary btn-sm" id="btnCommentCancel">취소</button>
                            <button type="button" class="btn btn-primary btn-sm" id="btnCommentSubmit">작성</button>
                        </div>
                    </form>

                <!--댓글 목록-->
                    <label for="commentUl" class="form-label"><br>댓글 목록</label>
                    <ul class="list-group list-group" id="commentUl">
                        <li class="list-group-item d-flex justify-content-between align-items-start" th:each="comment : ${comments}">
                            <div class="ms-2 me-auto col-sm-10">
                                <div class="fw-bold">[[${comment.writer}]] | [[${#strings.substring(comment.rdate, 0, 10)}]]</div>
                                <textarea class="col-sm-12 border-0" style="outline: none; resize: none;" readonly>[[${comment.content}]]</textarea>
                            </div>
                            <button type="button" class="me-2 mt-2 btn btn-sm btn-outline-secondary btnCommentDelete">삭제</button>
                            <!-- th:href="@{/article/commentDelete(parent=${comment.parent})}"-->
                            <button type="button" class="mt-2 btn btn-sm btn-outline-secondary btnCommentModify">수정</button>
                            <!-- th:href="@{/article/commentModify(parent=${comment.parent})}-->
                        </li>
                    </ul>

                </div> <!--card-body end-->
            </div>

        </div>
    <!--내용 끝-->
</html>
